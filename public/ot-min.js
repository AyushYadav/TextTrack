if(typeof ot=="undefined")var ot={};ot.TextOperation=function(){function e(){if(this.constructor!==e)return new e;this.ops=[],this.baseLength=0,this.targetLength=0}return e.prototype.retain=function(e){if(typeof e!="number")throw new Error("retain expects an integer");if(e===0)return this;this.baseLength+=e,this.targetLength+=e;var t=this.ops[this.ops.length-1];return t&&t.retain?t.retain+=e:this.ops.push({retain:e}),this},e.prototype.equals=function(e){if(this.baseLength!==e.baseLength)return!1;if(this.targetLength!==e.targetLength)return!1;if(this.ops.length!==e.ops.length)return!1;for(var t=0;t<this.ops.length;t++){var n=this.ops[t],r=e.ops[t];if(n.retain&&n.retain!==r.retain)return!1;if(n.insert&&n.insert!==r.insert)return!1;if(n.delete&&n.delete!==r.delete)return!1}return!0},e.prototype.insert=function(e){if(typeof e!="string")throw new Error("insert expects a string");if(e==="")return this;this.targetLength+=e.length;var t=this.ops[this.ops.length-1];return t&&t.insert?t.insert+=e:this.ops.push({insert:e}),this},e.prototype.delete=function(e){typeof e=="string"&&(e=e.length);if(typeof e!="number")throw new Error("delete expects an integer or a string");if(e===0)return this;e<0&&(e=-e),this.baseLength+=e;var t=this.ops[this.ops.length-1];return t&&t.delete?t.delete+=e:this.ops.push({"delete":e}),this},e.prototype.toString=function(){var e=Array.prototype.map||function(e){var t=this,n=[];for(var r=0,i=t.length;r<i;r++)n[r]=e(t[r]);return n};return e.call(this.ops,function(e){return e.retain?"retain "+e.retain:e.insert?"insert '"+e.insert+"'":"delete "+e.delete}).join(", ")},e.prototype.toJSON=function(){return this},e.fromJSON=function(t){var n=new e,r=t.ops;for(var i=0,s=r.length;i<s;i++){var o=r[i];if(o.retain)n.retain(o.retain);else if(o.insert)n.insert(o.insert);else{if(!o.delete)throw new Error("unknown operation: "+JSON.stringify(o));n.delete(o.delete)}}if(n.baseLength!==t.baseLength)throw new Error("baseLengths don't match");if(n.targetLength!==t.targetLength)throw new Error("targetLengths don't match");return n},e.prototype.apply=function(e){var t=this;if(e.length!==t.baseLength)throw new Error("The operation's base length must be equal to the string's length.");var n=[],r=0,i=0,s=this.ops;for(var o=0,u=s.length;o<u;o++){var a=s[o];if(a.retain){if(i+a.retain>e.length)throw new Error("Operation can't retain more characters than are left in the string.");n[r++]=e.slice(i,i+a.retain),i+=a.retain}else a.insert?n[r++]=a.insert:i+=a.delete}if(i!==e.length)throw new Error("The operation didn't operate on the whole string.");return n.join("")},e.prototype.invert=function(t){var n=0,r=new e,i=this.ops;for(var s=0,o=i.length;s<o;s++){var u=i[s];u.retain?(r.retain(u.retain),n+=u.retain):u.insert?r.delete(u.insert.length):(r.insert(t.slice(n,n+u.delete)),n+=u.delete)}return r},e.prototype.compose=function(t){var n=this;if(n.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");var r=new e,i=n.ops,s=t.ops,o=0,u=0,a=i[o++],f=s[u++];for(;;){if(typeof a=="undefined"&&typeof f=="undefined")break;if(a&&a.delete){r.delete(a.delete),a=i[o++];continue}if(f&&f.insert){r.insert(f.insert),f=s[u++];continue}if(typeof a=="undefined")throw new Error("Cannot compose operations: first operation is too short.");if(typeof f=="undefined")throw new Error("Cannot compose operations: fist operation is too long.");var l=a.retain||a.delete||a.insert.length,c=f.retain||f.delete||f.insert.length,h=Math.min(l,c);if(a.retain&&f.retain)r.retain(h),l>c?(a={retain:l-c},f=s[u++]):l===c?(a=i[o++],f=s[u++]):(a=i[o++],f={retain:c-l});else if(a.insert&&f.delete)l>c?(a={insert:a.insert.slice(c)},f=s[u++]):l===c?(a=i[o++],f=s[u++]):(a=i[o++],f={"delete":f.delete-l});else if(a.insert&&f.retain)l>c?(r.insert(a.insert.slice(0,c)),a={insert:a.insert.slice(c)},f=s[u++]):l===c?(r.insert(a.insert),a=i[o++],f=s[u++]):(r.insert(a.insert),a=i[o++],f={retain:c-l});else{if(!a.retain||!f.delete)throw new Error("This shouldn't happen: op1: "+JSON.stringify(a)+", op2: "+JSON.stringify(f));l>c?(r.delete(f.delete),a={retain:l-c},f=s[u++]):l===c?(r.delete(f.delete),a=i[o++],f=s[u++]):(r.delete(l),a=i[o++],f={"delete":f.delete-l})}}return r},e.transform=function(t,n){if(t.baseLength!==n.baseLength)throw new Error("Both operations have to have the same base length");var r=new e,i=new e,s=t.ops,o=n.ops,u=0,a=0,f=s[u++],l=o[a++];for(;;){if(typeof f=="undefined"&&typeof l=="undefined")break;if(f&&f.insert){r.insert(f.insert),i.retain(f.insert.length),f=s[u++];continue}if(l&&l.insert){r.retain(l.insert.length),i.insert(l.insert),l=o[a++];continue}if(typeof f=="undefined")throw new Error("Cannot compose operations: first operation is too short.");if(typeof l=="undefined")throw new Error("Cannot compose operations: fist operation is too long.");var c=f.retain||f.delete||f.insert.length,h=l.retain||l.delete||l.insert.length,p=Math.min(c,h);if(f.retain&&l.retain)r.retain(p),i.retain(p),c>h?(f={retain:c-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={retain:h-c});else if(f.delete&&l.delete)c>h?(f={"delete":f.delete-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={"delete":l.delete-c});else if(f.delete&&l.retain)r.delete(p),c>h?(f={"delete":f.delete-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={retain:l.retain-c});else{if(!f.retain||!l.delete)throw new Error("The two operations aren't compatible");i.delete(p),c>h?(f={retain:f.retain-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={"delete":l.delete-c})}}return[r,i]},e}(),typeof module=="object"&&(module.exports=ot.TextOperation);if(typeof ot=="undefined")var ot={};ot.WrappedOperation=function(e){function t(e,t){this.wrapped=e,this.meta=t||{}}function n(e,t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.wrapped.invert.apply(this.wrapped,arguments);return new t(e,this.meta)},t.prototype.compose=function(e){var r={};return n(this.meta,r),n(e.meta,r),new t(this.wrapped.compose(e.wrapped),r)},t.transform=function(e,n){var r=e.wrapped.constructor.transform,i=r(e.wrapped,n.wrapped);return[new t(i[0],e.meta),new t(i[1],n.meta)]},t}(this),typeof module=="object"&&(module.exports=ot.WrappedOperation);if(typeof ot=="undefined")var ot={};ot.Client=function(e){function t(e){this.revision=e,this.state=r}function n(){}function i(e){this.outstanding=e}function s(e,t){this.outstanding=e,this.buffer=t}t.prototype.setState=function(e){this.state=e},t.prototype.applyClient=function(e){this.setState(this.state.applyClient(this,e))},t.prototype.applyServer=function(e){this.revision++,this.setState(this.state.applyServer(this,e))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.sendOperation=function(e,t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(e){throw new Error("applyOperation must be defined in child class")},t.Synchronized=n,n.prototype.applyClient=function(e,t){return e.sendOperation(e.revision,t),new i(t)},n.prototype.applyServer=function(e,t){return e.applyOperation(t),this},n.prototype.serverAck=function(e){throw new Error("There is no pending operation.")};var r=new n;return t.AwaitingConfirm=i,i.prototype.applyClient=function(e,t){return new s(this.outstanding,t)},i.prototype.applyServer=function(e,t){var n=t.constructor.transform(this.outstanding,t);return e.applyOperation(n[1]),new i(n[0])},i.prototype.serverAck=function(e){return r},t.AwaitingWithBuffer=s,s.prototype.applyClient=function(e,t){var n=this.buffer.compose(t);return new s(this.outstanding,n)},s.prototype.applyServer=function(e,t){var n=t.constructor.transform,r=n(this.outstanding,t),i=n(this.buffer,r[1]);return e.applyOperation(i[1]),new s(r[0],i[0])},s.prototype.serverAck=function(e){return e.sendOperation(e.revision,this.buffer),new i(this.buffer)},t}(this),typeof module=="object"&&(module.exports=ot.Client),function(){function e(e,t){if(!e)throw new Error(t||"assertion error")}ot.TextOperation.fromCodeMirrorChange=function(e,t){function i(e){var t=e.line,n=e.ch,i=0;for(var s=0;s<e.line;s++)i+=r[s].length+1;return i+=n,i}function s(){var e=0;for(var t=0,n=r.length;t<n;t++)e+=r[t].length;return e+r.length-1}function o(e,t){if(e.line===t.line)return r[e.line].slice(e.ch,t.ch);var n=r[e.line].slice(e.ch)+"\n";for(var i=e.line+1;i<t.line;i++)n+=r[i]+"\n";return n+=r[t.line].slice(0,t.ch),n}function u(e,t,n){var i=e.slice(0),s=r[t.line].slice(0,t.ch),o=r[n.line].slice(n.ch);i[0]=s+i[0],i[i.length-1]+=o,i.unshift(n.line-t.line+1),i.unshift(t.line),r.splice.apply(r,i)}function a(e,t){var n=i(t.from),r=i(t.to),a=s();e.retain(n),e.delete(o(t.from,t.to)),e.insert(t.text.join("\n")),e.retain(a-r),u(t.text,t.from,t.to)}var n=new ot.TextOperation,r=t.split("\n");a(n,e);for(;;){e=e.next;if(!e)break;var f=new ot.TextOperation(n.revision+1);a(f,e),n=n.compose(f)}return n},ot.TextOperation.prototype.applyToCodeMirror=function(t){var n=this;t.operation(function(){var r=n.ops,i=0;for(var s=0,o=r.length;s<o;s++){var u=r[s];if(u.retain)i+=u.retain;else if(u.insert)t.replaceRange(u.insert,t.posFromIndex(i)),i+=u.insert.length;else if(u.delete){var a=t.posFromIndex(i),f=t.posFromIndex(i+u.delete);t.replaceRange("",a,f)}}e(i===t.getValue().length)})}}(),ot.CodeMirrorClient=function(){function r(t,n){this.socket=t,this.cm=n,this.fromServer=!1,this.unredo=!1,this.undoStack=[],this.redoStack=[],this.clients={},this.initializeClientList();var r=this;t.on("doc",function(t){e.call(r,t.revision),r.initializeCodeMirror(t.str),r.initializeSocket(),r.initializeClients(t.clients)})}function i(e,t,n,r,i,s){this.id=e,this.listEl=t,this.cm=n,this.name=r,this.selectionClassName="client-selection-"+a(1e6),this.li=document.createElement("li"),r&&(this.li.textContent=r,this.listEl.appendChild(this.li)),this.cursorEl=document.createElement("pre"),this.cursorEl.className="other-client",this.cursorEl.style.borderLeftWidth="2px",this.cursorEl.style.borderLeftStyle="solid",this.cursorEl.innerHTML="&nbsp;",typeof i=="number"&&typeof s=="number"&&this.updateCursor(i,s),this.setColor(r?c(r):Math.random())}function s(e){function t(e){var t=e.ops;return t.length===0||t.length===1&&!!t[0].retain}while(e.length>0){var n=e[e.length-1];if(!t(n))break;e.pop()}}function u(e){var t=e.ops;if(t[0].retain){var n=t[0].retain;return t[1].insert?n+t[1].insert.length:n}return t[0].insert?t[0].insert.length:0}function a(e){return Math.floor(Math.random()*e)}function f(e,t,n){function r(e){var t=Math.round(255*e).toString(16);return t.length===1?"0"+t:t}return"#"+r(e)+r(t)+r(n)}function l(e,t,n){if(t===0)return f(n,n,n);var r=n<.5?n*(1+t):n+t-t*n,i=2*n-r,s=function(e){return e<0&&(e+=1),e>1&&(e-=1),6*e<1?i+(r-i)*6*e:2*e<1?r:3*e<2?i+(r-i)*6*(2/3-e):i};return f(s(e+1/3),s(e),s(e-1/3))}function c(e){var t=1;for(var n=0;n<e.length;n++)t=17*(t+e.charCodeAt(n))%360;return t/360}function h(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}function p(e){e.parentNode&&e.parentNode.removeChild(e)}function d(e){try{var t=document.styleSheets.item(0),n=(t.rules?t.rules:t.cssRules).length;t.insertRule(e,n)}catch(r){console.error("Couldn't add style rule.",r)}}var e=ot.Client,t=ot.TextOperation,n=ot.WrappedOperation;h(r,e),r.prototype.applyClient=function(t){t.meta.cursor=this.cursor,t.meta.selectionEnd=this.selectionEnd,clearTimeout(this.sendCursorTimeout),e.prototype.applyClient.call(this,t)},r.prototype.applyServer=function(t){e.prototype.applyServer.call(this,t)},r.prototype.initializeSocket=function(){var e=this;this.socket.on("client_left",function(t){e.onClientLeft(t.clientId)}).on("set_name",function(t){var n=e.getClientObject(t.clientId);n.setName(t.name)}).on("ack",function(){e.serverAck()}).on("operation",function(r){var i=new n(t.fromJSON(r.operation),r.meta);console.log("Operation from server by client "+r.meta.clientId+":",i),e.applyServer(i)}).on("cursor",function(t){var n=e.getClientObject(t.clientId);n.updateCursor(t.cursor,t.selectionEnd)})},i.prototype.setColor=function(e){this.hue=e;var t=l(e,.75,.5);this.li&&(this.li.style.color=t),this.cursorEl.style.borderLeftColor=t;var n=l(e,.5,.9),r="."+this.selectionClassName,i="background:"+n+";",s=r+"{"+i+"}";d(s)},i.prototype.setName=function(e){this.name=e,this.li.textContent=e,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(c(e))},i.prototype.updateCursor=function(e,t){this.cursor=e,this.selectionEnd=t,p(this.cursorEl),this.mark&&(this.mark.clear(),delete this.mark);var n=cm.posFromIndex(e);if(e===t){var r=cm.cursorCoords(n);this.cursorEl.style.height=(r.bottom-r.top)*.85+"px",this.cm.addWidget(n,this.cursorEl,!1)}else{var i,s;t>e?(i=n,s=this.cm.posFromIndex(t)):(i=this.cm.posFromIndex(t),s=n),this.mark=this.cm.markText(i,s,this.selectionClassName)}},i.prototype.remove=function(){this.li&&p(this.li),this.cursorEl&&p(this.cursorEl),this.mark&&this.mark.clear()},r.prototype.getClientObject=function(e){var t=this.clients[e];return t?t:this.clients[e]=new i(e,this.clientListEl,this.cm)},r.prototype.onClientLeft=function(e){console.log("User disconnected: "+e);var t=this.clients[e];if(!t)return;t.remove(),delete this.clients[e]},r.prototype.initializeCodeMirror=function(e){var t=this.cm,n=this;t.setValue(e),this.oldValue=e,t.on("change",function(e,t){n.onCodeMirrorChange(t)}),t.on("cursorActivity",function(e){n.onCodeMirrorCursorActivity()}),t.undo=function(){n.undo()},t.redo=function(){n.redo()}},r.prototype.initializeClients=function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n.clientId=t,this.clients[t]=new i(n.clientId,this.clientListEl,this.cm,n.name,n.cursor,n.selectionEnd)}},r.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")};var o=20;return r.prototype.unredoHelper=function(e,t){s(e);if(e.length===0)return;var r=e.pop();t.push(r.invert(this.oldValue)),this.unredo=!0,r.applyToCodeMirror(this.cm),this.cursor=this.selectionEnd=u(r),this.cm.setCursor(this.cm.posFromIndex(this.cursor)),this.applyClient(new n(r))},r.prototype.transformUnredoStack=function(e,n){s(e);for(var r=e.length-1;r>=0;r--){var i=t.transform(e[r],n);e[r]=i[0],n=i[1]}},r.prototype.addOperationToUndo=function(e){function t(e,t){var n=e.ops;switch(n.length){case 0:return!0;case 1:return!!t(n[0]);case 2:return!!(n[0].retain&&t(n[1])||t(n[0])&&n[1].retain);case 3:return!!(n[0].retain&&t(n[1])&&n[2].retain);default:return!1}}function n(e){return t(e,function(e){return e.insert})}function r(e){return t(e,function(e){return e.delete})}function i(e,t){if(n(e)&&n(t))return n(e.compose(t));if(r(e)&&r(t)){var i=e.ops[0],s=t.ops;return i.retain?s[0].delete?i.retain===s[0].delete:i.retain===s[0].retain+s[1].delete:!1}return!1}if(this.undoStack.length===0)this.undoStack.push(e);else{var s=this.undoStack[this.undoStack.length-1];if(i(e,s)){var u=e.compose(s);this.undoStack[this.undoStack.length-1]=u}else this.undoStack.push(e),this.undoStack.length>o&&this.undoStack.shift()}this.redoStack.length>0&&(this.redoStack=[])},r.prototype.undo=function(){this.unredoHelper(this.undoStack,this.redoStack)},r.prototype.redo=function(){this.unredoHelper(this.redoStack,this.undoStack)},r.prototype.onCodeMirrorChange=function(e){var r=this.cm;try{if(!this.fromServer&&!this.unredo){var i=t.fromCodeMirrorChange(e,this.oldValue);this.addOperationToUndo(i.invert(this.oldValue)),this.applyClient(new n(i,{}))}}finally{this.fromServer=!1,this.unredo=!1,this.oldValue=r.getValue()}},r.prototype.onCodeMirrorCursorActivity=function(){function t(e,t){return e.line===t.line&&e.ch===t.ch}var e=this.cm,n=e.getCursor(),r=e.indexFromPos(n),i;if(e.somethingSelected()){var s=e.getCursor(!0),o=t(n,s)?e.getCursor(!1):s;i=e.indexFromPos(o)}else i=r;this.cursor=r,this.selectionEnd=i;if(this.state==="awaitingWithBuffer")this.buffer.meta.cursor=r,this.buffer.meta.selectionEnd=i;else{var u=this;clearTimeout(this.sendCursorTimeout),this.sendCursorTimeout=setTimeout(function(){u.socket.emit("cursor",{cursor:r,selectionEnd:i})},50)}},r.prototype.sendOperation=function(e,t){this.socket.emit("operation",{revision:e,meta:t.meta,operation:t.wrapped.toJSON()})},r.prototype.applyOperation=function(e){this.fromServer=!0,e.wrapped.applyToCodeMirror(this.cm);var t=e.meta,n=this.getClientObject(t.clientId);n.updateCursor(t.cursor,t.selectionEnd),this.transformUnredoStack(this.undoStack,e.wrapped),this.transformUnredoStack(this.redoStack,e.wrapped)},r}();