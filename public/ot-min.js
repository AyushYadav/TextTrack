/*
 *    /\
 *   /  \ operational-transformation 0.0.7
 *  /    \ http://ot.substance.io
 *  \    /
 *   \  / (c) 2012 Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ operational-transformation may be freely distributed under the MIT license.
 */
if(typeof ot=="undefined")var ot={};ot.TextOperation=function(){function e(){if(this.constructor!==e)return new e;this.ops=[],this.baseLength=0,this.targetLength=0}e.prototype.equals=function(e){if(this.baseLength!==e.baseLength)return!1;if(this.targetLength!==e.targetLength)return!1;if(this.ops.length!==e.ops.length)return!1;for(var t=0;t<this.ops.length;t++)if(this.ops[t]!==e.ops[t])return!1;return!0};var t=e.isRetain=function(e){return typeof e=="number"&&e>0},n=e.isInsert=function(e){return typeof e=="string"},r=e.isDelete=function(e){return typeof e=="number"&&e<0};return e.prototype.retain=function(e){if(typeof e!="number")throw new Error("retain expects an integer");return e===0?this:(this.baseLength+=e,this.targetLength+=e,t(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e),this)},e.prototype.insert=function(e){if(typeof e!="string")throw new Error("insert expects a string");return e===""?this:(this.targetLength+=e.length,n(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e),this)},e.prototype["delete"]=function(e){typeof e=="string"&&(e=e.length);if(typeof e!="number")throw new Error("delete expects an integer or a string");return e===0?this:(e>0&&(e=-e),this.baseLength-=e,r(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=e:this.ops.push(e),this)},e.prototype.toString=function(){var e=Array.prototype.map||function(e){var t=this,n=[];for(var r=0,i=t.length;r<i;r++)n[r]=e(t[r]);return n};return e.call(this.ops,function(e){return t(e)?"retain "+e:n(e)?"insert '"+e+"'":"delete "+ -e}).join(", ")},e.prototype.toJSON=function(){return this},e.fromJSON=function(i){var s=new e,o=i.ops;for(var u=0,a=o.length;u<a;u++){var f=o[u];if(t(f))s.retain(f);else if(n(f))s.insert(f);else{if(!r(f))throw new Error("unknown operation: "+JSON.stringify(f));s["delete"](f)}}if(s.baseLength!==i.baseLength)throw new Error("baseLengths don't match");if(s.targetLength!==i.targetLength)throw new Error("targetLengths don't match");return s},e.prototype.apply=function(e){var r=this;if(e.length!==r.baseLength)throw new Error("The operation's base length must be equal to the string's length.");var i=[],s=0,o=0,u=this.ops;for(var a=0,f=u.length;a<f;a++){var l=u[a];if(t(l)){if(o+l>e.length)throw new Error("Operation can't retain more characters than are left in the string.");i[s++]=e.slice(o,o+l),o+=l}else n(l)?i[s++]=l:o-=l}if(o!==e.length)throw new Error("The operation didn't operate on the whole string.");return i.join("")},e.prototype.invert=function(r){var i=0,s=new e,o=this.ops;for(var u=0,a=o.length;u<a;u++){var f=o[u];t(f)?(s.retain(f),i+=f):n(f)?s["delete"](f.length):(s.insert(r.slice(i,i-f)),i-=f)}return s},e.prototype.compose=function(i){var s=this;if(s.targetLength!==i.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");var o=new e,u=s.ops,a=i.ops,f=0,l=0,c=u[f++],h=a[l++];for(;;){if(typeof c=="undefined"&&typeof h=="undefined")break;if(r(c)){o["delete"](c),c=u[f++];continue}if(n(h)){o.insert(h),h=a[l++];continue}if(typeof c=="undefined")throw new Error("Cannot compose operations: first operation is too short.");if(typeof h=="undefined")throw new Error("Cannot compose operations: fist operation is too long.");if(t(c)&&t(h))c>h?(o.retain(h),c-=h,h=a[l++]):c===h?(o.retain(c),c=u[f++],h=a[l++]):(o.retain(c),h-=c,c=u[f++]);else if(n(c)&&r(h))c.length>-h?(c=c.slice(-h),h=a[l++]):c.length===-h?(c=u[f++],h=a[l++]):(h+=c.length,c=u[f++]);else if(n(c)&&t(h))c.length>h?(o.insert(c.slice(0,h)),c=c.slice(h),h=a[l++]):c.length===h?(o.insert(c),c=u[f++],h=a[l++]):(o.insert(c),h-=c.length,c=u[f++]);else{if(!t(c)||!r(h))throw new Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(h));c>-h?(o["delete"](h),c+=h,h=a[l++]):c===-h?(o["delete"](h),c=u[f++],h=a[l++]):(o["delete"](c),h+=c,c=u[f++])}}return o},e.transform=function(i,s){if(i.baseLength!==s.baseLength)throw new Error("Both operations have to have the same base length");var o=new e,u=new e,a=i.ops,f=s.ops,l=0,c=0,h=a[l++],p=f[c++];for(;;){if(typeof h=="undefined"&&typeof p=="undefined")break;if(n(h)){o.insert(h),u.retain(h.length),h=a[l++];continue}if(n(p)){o.retain(p.length),u.insert(p),p=f[c++];continue}if(typeof h=="undefined")throw new Error("Cannot compose operations: first operation is too short.");if(typeof p=="undefined")throw new Error("Cannot compose operations: fist operation is too long.");var d;if(t(h)&&t(p))h>p?(d=p,h-=p,p=f[c++]):h===p?(d=p,h=a[l++],p=f[c++]):(d=h,p-=h,h=a[l++]),o.retain(d),u.retain(d);else if(r(h)&&r(p))-h>-p?(h-=p,p=f[c++]):h===p?(h=a[l++],p=f[c++]):(p-=h,h=a[l++]);else if(r(h)&&t(p))-h>p?(d=p,h+=p,p=f[c++]):-h===p?(d=p,h=a[l++],p=f[c++]):(d=-h,p+=h,h=a[l++]),o["delete"](d);else{if(!t(h)||!r(p))throw new Error("The two operations aren't compatible");h>-p?(d=-p,h+=p,p=f[c++]):h===-p?(d=h,h=a[l++],p=f[c++]):(d=h,p+=h,h=a[l++]),u["delete"](d)}}return[o,u]},e}(),typeof module=="object"&&(module.exports=ot.TextOperation);if(typeof ot=="undefined")var ot={};ot.WrappedOperation=function(e){function t(e,t){this.wrapped=e,this.meta=t||{}}function n(e,t){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}return t.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},t.prototype.invert=function(){var e=this.wrapped.invert.apply(this.wrapped,arguments);return new t(e,this.meta)},t.prototype.compose=function(e){var r={};return n(this.meta,r),n(e.meta,r),new t(this.wrapped.compose(e.wrapped),r)},t.transform=function(e,n){var r=e.wrapped.constructor.transform,i=r(e.wrapped,n.wrapped);return[new t(i[0],e.meta),new t(i[1],n.meta)]},t}(this),typeof module=="object"&&(module.exports=ot.WrappedOperation);if(typeof ot=="undefined")var ot={};ot.Client=function(e){function t(e){this.revision=e,this.state=r}function n(){}function i(e){this.outstanding=e}function s(e,t){this.outstanding=e,this.buffer=t}t.prototype.setState=function(e){this.state=e},t.prototype.applyClient=function(e){this.setState(this.state.applyClient(this,e))},t.prototype.applyServer=function(e){this.revision++,this.setState(this.state.applyServer(this,e))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.sendOperation=function(e,t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(e){throw new Error("applyOperation must be defined in child class")},t.Synchronized=n,n.prototype.applyClient=function(e,t){return e.sendOperation(e.revision,t),new i(t)},n.prototype.applyServer=function(e,t){return e.applyOperation(t),this},n.prototype.serverAck=function(e){throw new Error("There is no pending operation.")};var r=new n;return t.AwaitingConfirm=i,i.prototype.applyClient=function(e,t){return new s(this.outstanding,t)},i.prototype.applyServer=function(e,t){var n=t.constructor.transform(this.outstanding,t);return e.applyOperation(n[1]),new i(n[0])},i.prototype.serverAck=function(e){return r},t.AwaitingWithBuffer=s,s.prototype.applyClient=function(e,t){var n=this.buffer.compose(t);return new s(this.outstanding,n)},s.prototype.applyServer=function(e,t){var n=t.constructor.transform,r=n(this.outstanding,t),i=n(this.buffer,r[1]);return e.applyOperation(i[1]),new s(r[0],i[0])},s.prototype.serverAck=function(e){return e.sendOperation(e.revision,this.buffer),new i(this.buffer)},t}(this),typeof module=="object"&&(module.exports=ot.Client),function(){function t(e,t){if(!e)throw new Error(t||"assertion error")}var e=ot.TextOperation;e.fromCodeMirrorChange=function(t,n){function s(e){var t=e.line,n=e.ch,r=0;for(var s=0;s<e.line;s++)r+=i[s].length+1;return r+=n,r}function o(){var e=0;for(var t=0,n=i.length;t<n;t++)e+=i[t].length;return e+i.length-1}function u(e,t){if(e.line===t.line)return i[e.line].slice(e.ch,t.ch);var n=i[e.line].slice(e.ch)+"\n";for(var r=e.line+1;r<t.line;r++)n+=i[r]+"\n";return n+=i[t.line].slice(0,t.ch),n}function a(e,t,n){var r=e.slice(0),s=i[t.line].slice(0,t.ch),o=i[n.line].slice(n.ch);r[0]=s+r[0],r[r.length-1]+=o,r.unshift(n.line-t.line+1),r.unshift(t.line),i.splice.apply(i,r)}function f(e,t){var n=s(t.from),r=s(t.to),i=o();e.retain(n),e["delete"](u(t.from,t.to)),e.insert(t.text.join("\n")),e.retain(i-r),a(t.text,t.from,t.to)}var r=new e,i=n.split("\n");f(r,t);for(;;){t=t.next;if(!t)break;var l=new e(r.revision+1);f(l,t),r=r.compose(l)}return r},e.prototype.applyToCodeMirror=function(n){var r=this;n.operation(function(){var i=r.ops,s=0;for(var o=0,u=i.length;o<u;o++){var a=i[o];if(e.isRetain(a))s+=a;else if(e.isInsert(a))n.replaceRange(a,n.posFromIndex(s)),s+=a.length;else if(e.isDelete(a)){var f=n.posFromIndex(s),l=n.posFromIndex(s-a);n.replaceRange("",f,l)}}t(s===n.getValue().length)})}}(),ot.CodeMirrorClient=function(){function r(t,n){this.socket=t,this.cm=n,this.fromServer=!1,this.unredo=!1,this.undoStack=[],this.redoStack=[],this.clients={},this.initializeClientList();var r=this;t.on("doc",function(t){e.call(r,t.revision),r.initializeCodeMirror(t.str),r.initializeSocket(),r.initializeClients(t.clients)})}function i(e,t,n,r,i,s){this.id=e,this.listEl=t,this.cm=n,this.name=r,this.selectionClassName="client-selection-"+a(1e6),this.li=document.createElement("li"),r&&(this.li.textContent=r,this.listEl.appendChild(this.li)),this.cursorEl=document.createElement("pre"),this.cursorEl.className="other-client",this.cursorEl.style.borderLeftWidth="2px",this.cursorEl.style.borderLeftStyle="solid",this.cursorEl.innerHTML="&nbsp;",typeof i=="number"&&typeof s=="number"&&this.updateCursor(i,s),this.setColor(r?c(r):Math.random())}function s(e){function n(e){var n=e.ops;return n.length===0||n.length===1&&t.isRetain(n[0])}while(e.length>0){var r=e[e.length-1];if(!n(r))break;e.pop()}}function u(e){var n=e.ops;if(t.isRetain(n[0])){var r=n[0];return t.isInsert(n[1])?r+n[1].length:r}return t.isInsert(n[0])?n[0].length:0}function a(e){return Math.floor(Math.random()*e)}function f(e,t,n){function r(e){var t=Math.round(255*e).toString(16);return t.length===1?"0"+t:t}return"#"+r(e)+r(t)+r(n)}function l(e,t,n){if(t===0)return f(n,n,n);var r=n<.5?n*(1+t):n+t-t*n,i=2*n-r,s=function(e){return e<0&&(e+=1),e>1&&(e-=1),6*e<1?i+(r-i)*6*e:2*e<1?r:3*e<2?i+(r-i)*6*(2/3-e):i};return f(s(e+1/3),s(e),s(e-1/3))}function c(e){var t=1;for(var n=0;n<e.length;n++)t=17*(t+e.charCodeAt(n))%360;return t/360}function h(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}function p(e){e.parentNode&&e.parentNode.removeChild(e)}function d(e){try{var t=document.styleSheets.item(0),n=(t.rules?t.rules:t.cssRules).length;t.insertRule(e,n)}catch(r){console.error("Couldn't add style rule.",r)}}var e=ot.Client,t=ot.TextOperation,n=ot.WrappedOperation;h(r,e),r.prototype.applyClient=function(t){t.meta.cursor=this.cursor,t.meta.selectionEnd=this.selectionEnd,clearTimeout(this.sendCursorTimeout),e.prototype.applyClient.call(this,t)},r.prototype.applyServer=function(t){e.prototype.applyServer.call(this,t)},r.prototype.initializeSocket=function(){var e=this;this.socket.on("client_left",function(t){e.onClientLeft(t.clientId)}).on("set_name",function(t){var n=e.getClientObject(t.clientId);n.setName(t.name)}).on("ack",function(){e.serverAck()}).on("operation",function(r){var i=new n(t.fromJSON(r.operation),r.meta);console.log("Operation from server by client "+r.meta.clientId+":",i),e.applyServer(i)}).on("cursor",function(t){var n=e.getClientObject(t.clientId);n.updateCursor(t.cursor,t.selectionEnd)})},i.prototype.setColor=function(e){this.hue=e;var t=l(e,.75,.5);this.li&&(this.li.style.color=t),this.cursorEl.style.borderLeftColor=t;var n=l(e,.5,.9),r="."+this.selectionClassName,i="background:"+n+";",s=r+"{"+i+"}";d(s)},i.prototype.setName=function(e){this.name=e,this.li.textContent=e,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(c(e))},i.prototype.updateCursor=function(e,t){this.cursor=e,this.selectionEnd=t,p(this.cursorEl),this.mark&&(this.mark.clear(),delete this.mark);var n=this.cm.posFromIndex(e);if(e===t){var r=this.cm.cursorCoords(n);this.cursorEl.style.height=(r.bottom-r.top)*.85+"px",this.cm.addWidget(n,this.cursorEl,!1)}else{var i,s;t>e?(i=n,s=this.cm.posFromIndex(t)):(i=this.cm.posFromIndex(t),s=n),this.mark=this.cm.markText(i,s,this.selectionClassName)}},i.prototype.remove=function(){this.li&&p(this.li),this.cursorEl&&p(this.cursorEl),this.mark&&this.mark.clear()},r.prototype.getClientObject=function(e){var t=this.clients[e];return t?t:this.clients[e]=new i(e,this.clientListEl,this.cm)},r.prototype.onClientLeft=function(e){console.log("User disconnected: "+e);var t=this.clients[e];if(!t)return;t.remove(),delete this.clients[e]},r.prototype.initializeCodeMirror=function(e){var t=this.cm,n=this;t.setValue(e),this.oldValue=e,t.on("change",function(e,t){n.onCodeMirrorChange(t)}),t.on("cursorActivity",function(e){n.onCodeMirrorCursorActivity()}),t.undo=function(){n.undo()},t.redo=function(){n.redo()}},r.prototype.initializeClients=function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n.clientId=t,this.clients[t]=new i(n.clientId,this.clientListEl,this.cm,n.name,n.cursor,n.selectionEnd)}},r.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")};var o=20;return r.prototype.unredoHelper=function(e,t){s(e);if(e.length===0)return;var r=e.pop();t.push(r.invert(this.oldValue)),this.unredo=!0,r.applyToCodeMirror(this.cm),this.cursor=this.selectionEnd=u(r),this.cm.setCursor(this.cm.posFromIndex(this.cursor)),this.applyClient(new n(r))},r.prototype.transformUnredoStack=function(e,n){s(e);for(var r=e.length-1;r>=0;r--){var i=t.transform(e[r],n);e[r]=i[0],n=i[1]}},r.prototype.addOperationToUndo=function(e){function n(e,n){var r=e.ops,i=t.isRetain;switch(r.length){case 0:return!0;case 1:return!!n(r[0]);case 2:return i(r[0])&&n(r[1])||n(r[0])&&i(r[1]);case 3:return i(r[0])&&n(r[1])&&i(r[2]);default:return!1}}function r(e){return n(e,t.isInsert)}function i(e){return n(e,t.isDelete)}function s(e,n){if(r(e)&&r(n))return r(e.compose(n));if(i(e)&&i(n)){var s=e.ops[0],o=n.ops;return t.isRetain(s)?t.isDelete(o[0])?s===-o[0]:s===o[0]-o[1]:!1}return!1}if(this.undoStack.length===0)this.undoStack.push(e);else{var u=this.undoStack[this.undoStack.length-1];if(s(e,u)){var a=e.compose(u);this.undoStack[this.undoStack.length-1]=a}else this.undoStack.push(e),this.undoStack.length>o&&this.undoStack.shift()}this.redoStack.length>0&&(this.redoStack=[])},r.prototype.undo=function(){this.unredoHelper(this.undoStack,this.redoStack)},r.prototype.redo=function(){this.unredoHelper(this.redoStack,this.undoStack)},r.prototype.onCodeMirrorChange=function(e){var r=this.cm;try{if(!this.fromServer&&!this.unredo){var i=t.fromCodeMirrorChange(e,this.oldValue);this.addOperationToUndo(i.invert(this.oldValue)),this.applyClient(new n(i,{}))}}finally{this.fromServer=!1,this.unredo=!1,this.oldValue=r.getValue()}},r.prototype.onCodeMirrorCursorActivity=function(){function t(e,t){return e.line===t.line&&e.ch===t.ch}var e=this.cm,n=e.getCursor(),r=e.indexFromPos(n),i;if(e.somethingSelected()){var s=e.getCursor(!0),o=t(n,s)?e.getCursor(!1):s;i=e.indexFromPos(o)}else i=r;this.cursor=r,this.selectionEnd=i;if(this.state==="awaitingWithBuffer")this.buffer.meta.cursor=r,this.buffer.meta.selectionEnd=i;else{var u=this;clearTimeout(this.sendCursorTimeout),this.sendCursorTimeout=setTimeout(function(){u.socket.emit("cursor",{cursor:r,selectionEnd:i})},50)}},r.prototype.sendOperation=function(e,t){this.socket.emit("operation",{revision:e,meta:t.meta,operation:t.wrapped.toJSON()})},r.prototype.applyOperation=function(e){this.fromServer=!0,e.wrapped.applyToCodeMirror(this.cm);var t=e.meta,n=this.getClientObject(t.clientId);n.updateCursor(t.cursor,t.selectionEnd),this.transformUnredoStack(this.undoStack,e.wrapped),this.transformUnredoStack(this.redoStack,e.wrapped)},r}();